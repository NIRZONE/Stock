<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Inventory Management System (Auth)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        /* ===========
           --- ORIGINAL InventoryApp CODE START ---
           (kept exactly as provided, unchanged)
           =========== */
        const InventoryApp = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [employees, setEmployees] = useState([]);
            const [categories, setCategories] = useState(['SIM', 'Hardware', 'Accessories']);
            const [companyStock, setCompanyStock] = useState([]);
            const [allocations, setAllocations] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [autoBackupEnabled, setAutoBackupEnabled] = useState(false);

            // GitHub configuration (users will fill this)
            const [githubConfig, setGithubConfig] = useState({
                token: '',
                username: '',
                repo: '',
                configured: false
            });

            useEffect(() => {
                loadFromLocalStorage();
                loadGitHubConfig();
            }, []);

            const loadFromLocalStorage = () => {
                const saved = localStorage.getItem('inventoryData');
                if (saved) {
                    const data = JSON.parse(saved);
                    setEmployees(data.employees || []);
                    setCategories(data.categories || ['SIM', 'Hardware', 'Accessories']);
                    setCompanyStock(data.companyStock || []);
                    setAllocations(data.allocations || []);
                    setTransactions(data.transactions || []);
                }
            };

            const loadGitHubConfig = () => {
                const saved = localStorage.getItem('githubConfig');
                if (saved) {
                    const config = JSON.parse(saved);
                    setGithubConfig(config);
                    setAutoBackupEnabled(config.autoBackup || false);
                }
            };

            useEffect(() => {
                const data = { employees, categories, companyStock, allocations, transactions };
                localStorage.setItem('inventoryData', JSON.stringify(data));

                // Auto backup to GitHub if enabled
                if (autoBackupEnabled && githubConfig.configured) {
                    autoBackupToGitHub(data);
                }
            }, [employees, categories, companyStock, allocations, transactions, autoBackupEnabled, githubConfig]);

            const autoBackupToGitHub = async (data) => {
                try {
                    await saveToGitHub(data, true);
                } catch (error) {
                    console.error('Auto backup failed:', error);
                }
            };

            const saveToGitHub = async (data, isAuto = false) => {
                if (!githubConfig.configured) {
                    alert('Please configure GitHub settings first!');
                    return;
                }

                const backupData = {
                    ...data,
                    backupDate: new Date().toISOString(),
                    version: '1.0'
                };

                const content = btoa(JSON.stringify(backupData, null, 2));
                const fileName = 'inventory-backup.json';
                const url = `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/${fileName}`;

                try {
                    // Check if file exists
                    let sha = null;
                    try {
                        const checkResponse = await fetch(url, {
                            headers: {
                                'Authorization': `token ${githubConfig.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        if (checkResponse.ok) {
                            const fileData = await checkResponse.json();
                            sha = fileData.sha;
                        }
                    } catch (e) {
                        // File doesn't exist yet
                    }

                    // Create or update file
                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${githubConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: isAuto ? `Auto backup - ${new Date().toLocaleString()}` : `Manual backup - ${new Date().toLocaleString()}`,
                            content: content,
                            ...(sha && { sha: sha })
                        })
                    });

                    if (response.ok) {
                        if (!isAuto) {
                            alert('‚úÖ Backup saved to GitHub successfully!');
                        }
                    } else {
                        const error = await response.json();
                        throw new Error(error.message);
                    }
                } catch (error) {
                    if (!isAuto) {
                        alert('‚ùå Backup failed: ' + error.message);
                    }
                    console.error('GitHub backup error:', error);
                }
            };

            const restoreFromGitHub = async () => {
                if (!githubConfig.configured) {
                    alert('Please configure GitHub settings first!');
                    return;
                }

                const fileName = 'inventory-backup.json';
                const url = `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/${fileName}`;

                try {
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `token ${githubConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (response.ok) {
                        const fileData = await response.json();
                        const content = atob(fileData.content);
                        const backupData = JSON.parse(content);

                        if (confirm(`Restore backup from ${new Date(backupData.backupDate).toLocaleString()}?\n\nThis will replace all current data!`)) {
                            setEmployees(backupData.employees || []);
                            setCategories(backupData.categories || ['SIM', 'Hardware', 'Accessories']);
                            setCompanyStock(backupData.companyStock || []);
                            setAllocations(backupData.allocations || []);
                            setTransactions(backupData.transactions || []);
                            alert('‚úÖ Data restored successfully from GitHub!');
                        }
                    } else {
                        alert('‚ùå No backup found on GitHub!');
                    }
                } catch (error) {
                    alert('‚ùå Restore failed: ' + error.message);
                    console.error('GitHub restore error:', error);
                }
            };

            const downloadBackup = () => {
                const data = { employees, categories, companyStock, allocations, transactions, backupDate: new Date().toISOString() };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `inventory-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const uploadBackup = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (confirm(`Restore backup from ${new Date(data.backupDate).toLocaleString()}?\n\nThis will replace all current data!`)) {
                            setEmployees(data.employees || []);
                            setCategories(data.categories || ['SIM', 'Hardware', 'Accessories']);
                            setCompanyStock(data.companyStock || []);
                            setAllocations(data.allocations || []);
                            setTransactions(data.transactions || []);
                            alert('‚úÖ Backup restored successfully!');
                        }
                    } catch (error) {
                        alert('‚ùå Invalid backup file!');
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            const BackupSettings = () => {
                const [token, setToken] = useState(githubConfig.token);
                const [username, setUsername] = useState(githubConfig.username);
                const [repo, setRepo] = useState(githubConfig.repo);

                const saveGitHubConfig = () => {
                    const config = { token, username, repo, configured: true, autoBackup: autoBackupEnabled };
                    setGithubConfig(config);
                    localStorage.setItem('githubConfig', JSON.stringify(config));
                    alert('‚úÖ GitHub configuration saved!');
                };

                const testConnection = async () => {
                    try {
                        const response = await fetch(`https://api.github.com/repos/${username}/${repo}`, {
                            headers: {
                                'Authorization': `token ${token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        if (response.ok) {
                            alert('‚úÖ Connection successful!');
                        } else {
                            alert('‚ùå Connection failed! Check your settings.');
                        }
                    } catch (error) {
                        alert('‚ùå Connection error: ' + error.message);
                    }
                };

                return (
                    <div className="bg-white p-6 rounded-lg shadow">
                        <h2 className="text-2xl font-bold mb-4">Backup & Restore</h2>

                        <div className="space-y-6">
                            {/* Local Backup */}
                            <div className="border rounded-lg p-4">
                                <h3 className="text-xl font-bold mb-3">üìÅ Local Backup (Download/Upload)</h3>
                                <div className="flex gap-3">
                                    <button onClick={downloadBackup} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                        Download Backup File
                                    </button>
                                    <label className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 cursor-pointer">
                                        Upload Backup File
                                        <input type="file" accept=".json" onChange={uploadBackup} className="hidden" />
                                    </label>
                                </div>
                                <p className="text-sm text-gray-600 mt-2">Download backup file and keep it safe. Use upload to restore data.</p>
                            </div>

                            {/* GitHub Backup */}
                            <div className="border rounded-lg p-4">
                                <h3 className="text-xl font-bold mb-3">üîÑ GitHub Backup (Auto Save)</h3>

                                <div className="bg-yellow-50 border border-yellow-200 p-3 rounded mb-4">
                                    <p className="text-sm font-semibold mb-2">üìù Setup Instructions:</p>
                                    <ol className="text-sm space-y-1 ml-4 list-decimal">
                                        <li>Go to <a href="https://github.com" target="_blank" className="text-blue-600 underline">GitHub.com</a></li>
                                        <li>Create a new repository (can be private)</li>
                                        <li>Go to Settings ‚Üí Developer settings ‚Üí Personal access tokens ‚Üí Tokens (classic)</li>
                                        <li>Generate new token with "repo" permission</li>
                                        <li>Copy token and paste below</li>
                                    </ol>
                                </div>

                                <div className="space-y-3">
                                    <div>
                                        <label className="block mb-1 font-semibold">GitHub Username</label>
                                        <input type="text" value={username} onChange={e => setUsername(e.target.value)} placeholder="your-github-username" className="w-full p-2 border rounded" />
                                    </div>
                                    <div>
                                        <label className="block mb-1 font-semibold">Repository Name</label>
                                        <input type="text" value={repo} onChange={e => setRepo(e.target.value)} placeholder="inventory-backup" className="w-full p-2 border rounded" />
                                    </div>
                                    <div>
                                        <label className="block mb-1 font-semibold">Personal Access Token</label>
                                        <input type="password" value={token} onChange={e => setToken(e.target.value)} placeholder="ghp_xxxxxxxxxxxx" className="w-full p-2 border rounded" />
                                    </div>

                                    <div className="flex items-center gap-2 p-3 bg-gray-50 rounded">
                                        <input type="checkbox" id="autoBackup" checked={autoBackupEnabled} onChange={e => setAutoBackupEnabled(e.target.checked)} className="w-4 h-4" />
                                        <label htmlFor="autoBackup" className="font-semibold">Enable Auto Backup (saves every change to GitHub)</label>
                                    </div>

                                    <div className="flex gap-3">
                                        <button onClick={saveGitHubConfig} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                            Save Configuration
                                        </button>
                                        <button onClick={testConnection} className="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                                            Test Connection
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Backup Actions */}
                            {githubConfig.configured && (
                                <div className="border rounded-lg p-4 bg-green-50">
                                    <h3 className="text-xl font-bold mb-3">‚úÖ GitHub Connected</h3>
                                    <div className="flex gap-3">
                                        <button onClick={() => saveToGitHub({ employees, categories, companyStock, allocations, transactions })} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                                            Backup Now to GitHub
                                        </button>
                                        <button onClick={restoreFromGitHub} className="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700">
                                            Restore from GitHub
                                        </button>
                                    </div>
                                    <p className="text-sm text-gray-600 mt-2">
                                        {autoBackupEnabled ? 'üü¢ Auto backup is ON - Data saves automatically' : 'üî¥ Auto backup is OFF - Use manual backup'}
                                    </p>
                                </div>
                            )}

                            {/* Migration Guide */}
                            <div className="border rounded-lg p-4 bg-blue-50">
                                <h3 className="text-xl font-bold mb-3">üöÄ Migration Guide</h3>
                                <div className="text-sm space-y-2">
                                    <p><strong>To migrate to a new host:</strong></p>
                                    <ol className="ml-4 list-decimal space-y-1">
                                        <li>Download backup file OR ensure GitHub backup is saved</li>
                                        <li>Upload this HTML file to new hosting platform</li>
                                        <li>Open the website</li>
                                        <li>Go to Backup & Restore</li>
                                        <li>Either upload the backup file OR configure GitHub and restore</li>
                                        <li>All data will be restored!</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const Dashboard = () => (
                <div className="bg-white p-6 rounded-lg shadow">
                    <h2 className="text-2xl font-bold mb-6">Dashboard</h2>
                    <div className="grid grid-cols-4 gap-4 mb-6">
                        <div className="bg-blue-50 p-4 rounded border border-blue-200">
                            <p className="text-gray-600 text-sm">Employees</p>
                            <p className="text-3xl font-bold text-blue-700">{employees.length}</p>
                        </div>
                        <div className="bg-green-50 p-4 rounded border border-green-200">
                            <p className="text-gray-600 text-sm">Company Stock</p>
                            <p className="text-3xl font-bold text-green-700">{companyStock.length}</p>
                        </div>
                        <div className="bg-orange-50 p-4 rounded border border-orange-200">
                            <p className="text-gray-600 text-sm">Allocated</p>
                            <p className="text-3xl font-bold text-orange-700">{allocations.length}</p>
                        </div>
                        <div className="bg-purple-50 p-4 rounded border border-purple-200">
                            <p className="text-gray-600 text-sm">Total Stock</p>
                            <p className="text-3xl font-bold text-purple-700">{companyStock.length + allocations.length}</p>
                        </div>
                    </div>
                    {githubConfig.configured && (
                        <div className="bg-green-100 border border-green-300 p-3 rounded">
                            <p className="font-semibold">‚úÖ GitHub Backup: Connected</p>
                            <p className="text-sm text-gray-700">
                                {autoBackupEnabled ? 'üü¢ Auto backup enabled - Your data is safe!' : 'üî¥ Auto backup disabled - Enable in Backup Settings'}
                            </p>
                        </div>
                    )}
                </div>
            );

            const EmployeeRegistration = () => {
                const [empType, setEmpType] = useState('DSR');
                const [name, setName] = useState('');
                const [id1, setId1] = useState('');
                const [id2, setId2] = useState('');
                const [phone1, setPhone1] = useState('');
                const [phone2, setPhone2] = useState('');
                const [numberId, setNumberId] = useState('');

                const handleSubmit = (e) => {
                    e.preventDefault();
                    const newEmp = {
                        empId: 'EMP' + Date.now(),
                        name, type: empType,
                        id1, id2, phone1, phone2, numberId,
                        createdAt: new Date().toISOString()
                    };
                    setEmployees([...employees, newEmp]);
                    setName(''); setId1(''); setId2(''); setPhone1(''); setPhone2(''); setNumberId('');
                    alert('Employee registered!');
                };

                return (
                    <div className="bg-white p-6 rounded-lg shadow">
                        <h2 className="text-2xl font-bold mb-4">Employee Registration</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block mb-2 font-semibold">Employee Type</label>
                                <select value={empType} onChange={e => setEmpType(e.target.value)} className="w-full p-2 border rounded">
                                    <option value="DSR">DSR</option>
                                    <option value="BP">BP</option>
                                </select>
                            </div>
                            <div>
                                <label className="block mb-2 font-semibold">Name</label>
                                <input type="text" value={name} onChange={e => setName(e.target.value)} className="w-full p-2 border rounded" required />
                            </div>
                            {empType === 'DSR' ? (
                                <>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block mb-2 font-semibold">ID 1</label>
                                            <input type="text" value={id1} onChange={e => setId1(e.target.value)} className="w-full p-2 border rounded" required />
                                        </div>
                                        <div>
                                            <label className="block mb-2 font-semibold">ID 2</label>
                                            <input type="text" value={id2} onChange={e => setId2(e.target.value)} className="w-full p-2 border rounded" required />
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block mb-2 font-semibold">Phone 1</label>
                                            <input type="text" value={phone1} onChange={e => setPhone1(e.target.value)} className="w-full p-2 border rounded" required />
                                        </div>
                                        <div>
                                            <label className="block mb-2 font-semibold">Phone 2</label>
                                            <input type="text" value={phone2} onChange={e => setPhone2(e.target.value)} className="w-full p-2 border rounded" required />
                                        </div>
                                    </div>
                                </>
                            ) : (
                                <div>
                                    <label className="block mb-2 font-semibold">Number ID</label>
                                    <input type="text" value={numberId} onChange={e => setNumberId(e.target.value)} className="w-full p-2 border rounded" required />
                                </div>
                            )}
                            <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Register Employee</button>
                        </form>

                        <div className="mt-8">
                            <h3 className="text-xl font-bold mb-4">Registered Employees ({employees.length})</h3>
                            <table className="w-full border-collapse">
                                <thead>
                                    <tr className="bg-gray-100">
                                        <th className="border p-2">Name</th>
                                        <th className="border p-2">Type</th>
                                        <th className="border p-2">Details</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {employees.map(emp => (
                                        <tr key={emp.empId}>
                                            <td className="border p-2">{emp.name}</td>
                                            <td className="border p-2">{emp.type}</td>
                                            <td className="border p-2">
                                                {emp.type === 'DSR' 
                                                    ? `ID: ${emp.id1}, ${emp.id2} | Ph: ${emp.phone1}, ${emp.phone2}`
                                                    : `ID: ${emp.numberId}`}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            const AddStock = () => {
                const [entryMode, setEntryMode] = useState('continuous');
                const [category, setCategory] = useState(categories[0] || '');
                const [newCategory, setNewCategory] = useState('');
                const [productName, setProductName] = useState('');
                const [serialStart, setSerialStart] = useState('');
                const [serialEnd, setSerialEnd] = useState('');
                const [singleSerial, setSingleSerial] = useState('');
                const [searchTerm, setSearchTerm] = useState('');
... (truncated for brevity) ... 
        // === END of original InventoryApp code (kept intact) === //

        /* ===========
           Auth wrapper and user management (new code)
           - Uses Web Crypto SHA-256 hashing
           - Stores users in localStorage under "ims_users"
           - Stores logged in username under "ims_loggedInUser"
           =========== */

        // helper: SHA-256 hashing, returns hex string
        async function hashPassword(password) {
            const enc = new TextEncoder();
            const data = enc.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        function getUsers() {
            const raw = localStorage.getItem('ims_users');
            if (!raw) return null;
            try {
                return JSON.parse(raw);
            } catch (e) {
                return null;
            }
        }

        function saveUsers(users) {
            localStorage.setItem('ims_users', JSON.stringify(users));
        }

        async function ensureDefaultAdmin() {
            let users = getUsers();
            if (!users || users.length === 0) {
                const defaultPassHash = await hashPassword('admin123');
                users = [{ username: 'admin', passwordHash: defaultPassHash, role: 'admin', createdAt: new Date().toISOString() }];
                saveUsers(users);
            }
        }

        // Login component (Tailwind blue style)
        const LoginScreen = ({ onLogin }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            useEffect(() => {
                (async () => { await ensureDefaultAdmin(); })();
            }, []);

            const handleSubmit = async (e) => {
                e.preventDefault();
                const users = getUsers() || [];
                const user = users.find(u => u.username === username);
                if (!user) {
                    setError('Invalid credentials');
                    return;
                }
                const passHash = await hashPassword(password);
                if (passHash !== user.passwordHash) {
                    setError('Invalid credentials');
                    return;
                }
                setError('');
                localStorage.setItem('ims_loggedInUser', username);
                onLogin(username);
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-blue-600">
                    <div className="bg-white rounded-lg shadow-lg p-8 w-full max-w-md">
                        <h1 className="text-2xl font-bold text-blue-600 mb-4">Inventory Management</h1>
                        <p className="text-sm text-gray-600 mb-6">Please login to continue</p>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-semibold mb-1">Username</label>
                                <input value={username} onChange={e => setUsername(e.target.value)} className="w-full p-2 border rounded" required />
                            </div>
                            <div>
                                <label className="block text-sm font-semibold mb-1">Password</label>
                                <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-2 border rounded" required />
                            </div>
                            {error && <div className="text-red-600 text-sm">{error}</div>}
                            <div className="flex justify-between items-center">
                                <button type="submit" className="bg-blue-600 text-white px-4 py-2 rounded">Login</button>
                                <button type="button" className="text-sm text-gray-600" onClick={() => { alert('Contact admin to create an account.'); }}>Need an account?</button>
                            </div>
                            <div className="text-xs text-gray-500 mt-2">Default admin created if no users exist: <strong>admin / admin123</strong></div>
                        </form>
                    </div>
                </div>
            );
        };

        // Floating user widget (top-right) and modals for admin/user actions
        const UserWidget = ({ currentUser, onLogout, onUserListChange }) => {
            const [users, setUsers] = useState(getUsers() || []);
            const [showMgmt, setShowMgmt] = useState(false);
            const [showChangeOwn, setShowChangeOwn] = useState(false);
            const [newUserName, setNewUserName] = useState('');
            const [newUserPass, setNewUserPass] = useState('');
            const [selectedUser, setSelectedUser] = useState(null);
            const [changePassFor, setChangePassFor] = useState('');
            const [changePassNew, setChangePassNew] = useState('');
            const [adminAuthPass, setAdminAuthPass] = useState('');
            const [filter, setFilter] = useState('');

            useEffect(() => {
                setUsers(getUsers() || []);
            }, [showMgmt]);

            const refresh = () => {
                const u = getUsers() || [];
                setUsers(u);
                onUserListChange && onUserListChange(u);
            };

            const addUser = async () => {
                if (!newUserName || !newUserPass) {
                    alert('Enter username and password');
                    return;
                }
                const ulist = getUsers() || [];
                if (ulist.find(x => x.username === newUserName)) {
                    alert('Username already exists');
                    return;
                }
                const passHash = await hashPassword(newUserPass);
                ulist.push({ username: newUserName, passwordHash: passHash, role: 'user', createdAt: new Date().toISOString() });
                saveUsers(ulist);
                setNewUserName(''); setNewUserPass('');
                refresh();
                alert('User added (role: user). Promote from admin panel if needed.');
            };

            const requestPromotion = async (targetUsername, makeAdmin) => {
                if (!adminAuthPass) {
                    alert('Admin password required to change roles');
                    return;
                }
                const usersList = getUsers() || [];
                const adminUser = usersList.find(u => u.username === currentUser.username);
                const adminPassHash = await hashPassword(adminAuthPass);
                if (!adminUser || adminUser.passwordHash !== adminPassHash) {
                    alert('Admin authentication failed');
                    return;
                }
                const target = usersList.find(u => u.username === targetUsername);
                if (!target) {
                    alert('Target user not found');
                    return;
                }
                target.role = makeAdmin ? 'admin' : 'user';
                saveUsers(usersList);
                setAdminAuthPass('');
                refresh();
                alert(`User ${targetUsername} role changed to ${target.role}`);
            };

            const deleteUser = (username) => {
                if (!confirm('Delete user ' + username + ' ?')) return;
                const ulist = (getUsers() || []).filter(u => u.username !== username);
                saveUsers(ulist);
                refresh();
            };

            const changePasswordForUser = async () => {
                if (!changePassFor || !changePassNew) {
                    alert('Select user and enter new password');
                    return;
                }
                const ulist = getUsers() || [];
                const target = ulist.find(u => u.username === changePassFor);
                if (!target) { alert('User not found'); return; }
                const newHash = await hashPassword(changePassNew);
                target.passwordHash = newHash;
                saveUsers(ulist);
                setChangePassFor(''); setChangePassNew('');
                refresh();
                alert('Password changed for ' + target.username);
            };

            const changeOwnPassword = async (oldPass, newPass) => {
                if (!oldPass || !newPass) { alert('Enter both old and new password'); return; }
                const ulist = getUsers() || [];
                const me = ulist.find(u => u.username === currentUser.username);
                if (!me) { alert('Your user not found'); return; }
                const oldHash = await hashPassword(oldPass);
                if (oldHash !== me.passwordHash) { alert('Old password incorrect'); return; }
                me.passwordHash = await hashPassword(newPass);
                saveUsers(ulist);
                alert('Password updated');
                setShowChangeOwn(false);
            };

            return (
                <>
                    {/* Floating top-right user box */}
                    <div className="fixed top-4 right-4 z-50">
                        <div className="bg-white border rounded shadow p-3 flex items-center gap-3">
                            <div>
                                <div className="text-sm font-semibold">{currentUser.username}</div>
                                <div className="text-xs text-gray-600">{currentUser.role}</div>
                            </div>
                            <div className="flex gap-2">
                                {currentUser.role === 'admin' && (
                                    <button className="bg-indigo-600 text-white px-2 py-1 rounded text-sm" onClick={() => setShowMgmt(true)}>User Mgmt</button>
                                )}
                                <button className="bg-blue-600 text-white px-2 py-1 rounded text-sm" onClick={() => setShowChangeOwn(true)}>Change Pass</button>
                                <button className="bg-gray-200 text-gray-800 px-2 py-1 rounded text-sm" onClick={onLogout}>Logout</button>
                            </div>
                        </div>
                    </div>

                    {/* User Management Modal (admin only) */}
                    {showMgmt && (
                        <div className="fixed inset-0 bg-black/40 flex items-start justify-center p-6 z-50">
                            <div className="bg-white w-full max-w-3xl rounded shadow p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-semibold">User Management (Admin)</h3>
                                    <div className="flex gap-2">
                                        <input type="text" placeholder="Filter" value={filter} onChange={e => setFilter(e.target.value)} className="p-2 border rounded" />
                                        <button className="text-sm text-gray-500" onClick={() => setShowMgmt(false)}>Close</button>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-6">
                                    <div>
                                        <h4 className="font-semibold mb-2">Existing Users</h4>
                                        <div className="max-h-96 overflow-y-auto border rounded p-2">
                                            <table className="w-full text-sm">
                                                <thead className="bg-gray-50">
                                                    <tr>
                                                        <th className="p-2 border text-left">Username</th>
                                                        <th className="p-2 border text-left">Role</th>
                                                        <th className="p-2 border text-left">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {users.filter(u => u.username.includes(filter)).map(u => (
                                                        <tr key={u.username}>
                                                            <td className="p-2 border">{u.username}</td>
                                                            <td className="p-2 border">{u.role}</td>
                                                            <td className="p-2 border">
                                                                <div className="flex gap-2">
                                                                    <button className="text-xs px-2 py-1 bg-yellow-100 rounded" onClick={() => { setChangePassFor(u.username); setSelectedUser(u); }}>Change Pass</button>
                                                                    {u.username !== currentUser.username && (
                                                                        <>
                                                                            {u.role !== 'admin' ? (
                                                                                <button className="text-xs px-2 py-1 bg-green-100 rounded" onClick={() => { if (confirm('Promote ' + u.username + ' to admin? You will need to re-enter your admin password.')) { const p = prompt('Re-enter your admin password:'); setAdminAuthPass(p || ''); requestPromotion(u.username, true); } }}>Promote</button>
                                                                            ) : (
                                                                                <button className="text-xs px-2 py-1 bg-red-100 rounded" onClick={() => { if (confirm('Demote ' + u.username + ' to normal user? You will need to re-enter your admin password.')) { const p = prompt('Re-enter your admin password:'); setAdminAuthPass(p || ''); requestPromotion(u.username, false); } }}>Demote</button>
                                                                            )}
                                                                            <button className="text-xs px-2 py-1 bg-red-200 rounded" onClick={() => deleteUser(u.username)}>Delete</button>
                                                                        </>
                                                                    )}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <div>
                                        <h4 className="font-semibold mb-2">Add New User</h4>
                                        <div className="border rounded p-3">
                                            <label className="block text-sm mb-1">Username</label>
                                            <input value={newUserName} onChange={e => setNewUserName(e.target.value)} className="w-full p-2 border rounded mb-2" />
                                            <label className="block text-sm mb-1">Password</label>
                                            <input type="password" value={newUserPass} onChange={e => setNewUserPass(e.target.value)} className="w-full p-2 border rounded mb-2" />
                                            <div className="flex gap-2">
                                                <button className="bg-blue-600 text-white px-3 py-2 rounded" onClick={addUser}>Add User (role: user)</button>
                                                <button className="bg-gray-200 px-3 py-2 rounded" onClick={() => { setNewUserName(''); setNewUserPass(''); }}>Clear</button>
                                            </div>
                                        </div>

                                        <div className="mt-4">
                                            <h4 className="font-semibold mb-2">Change Password (Selected User)</h4>
                                            <div className="border rounded p-3">
                                                <label className="block text-sm mb-1">Username</label>
                                                <input value={changePassFor} onChange={e => setChangePassFor(e.target.value)} className="w-full p-2 border rounded mb-2" />
                                                <label className="block text-sm mb-1">New Password</label>
                                                <input type="password" value={changePassNew} onChange={e => setChangePassNew(e.target.value)} className="w-full p-2 border rounded mb-2" />
                                                <div className="flex gap-2">
                                                    <button className="bg-yellow-600 text-white px-3 py-2 rounded" onClick={changePasswordForUser}>Change Password</button>
                                                    <button className="bg-gray-200 px-3 py-2 rounded" onClick={() => { setChangePassFor(''); setChangePassNew(''); }}>Clear</button>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Change own password modal */}
                    {showChangeOwn && (
                        <ChangeOwnPasswordModal username={currentUser.username} onClose={() => setShowChangeOwn(false)} onChange={changeOwnPassword} />
                    )}
                </>
            );
        };

        const ChangeOwnPasswordModal = ({ username, onClose, onChange }) => {
            const [oldPass, setOldPass] = useState('');
            const [newPass, setNewPass] = useState('');
            return (
                <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
                    <div className="bg-white rounded p-6 w-full max-w-md">
                        <h3 className="font-semibold mb-3">Change Password ({username})</h3>
                        <label className="block text-sm mb-1">Old Password</label>
                        <input type="password" value={oldPass} onChange={e => setOldPass(e.target.value)} className="w-full p-2 border rounded mb-2" />
                        <label className="block text-sm mb-1">New Password</label>
                        <input type="password" value={newPass} onChange={e => setNewPass(e.target.value)} className="w-full p-2 border rounded mb-4" />
                        <div className="flex gap-2">
                            <button className="bg-blue-600 text-white px-3 py-2 rounded" onClick={() => onChange(oldPass, newPass)}>Update Password</button>
                            <button className="bg-gray-200 px-3 py-2 rounded" onClick={onClose}>Cancel</button>
                        </div>
                    </div>
                </div>
            );
        };

        // Auth wrapper that shows login screen if not logged in, otherwise InventoryApp + user widget
        const AuthApp = () => {
            const [currentUser, setCurrentUser] = useState(null);
            const [usersList, setUsersList] = useState(getUsers() || []);

            useEffect(() => {
                (async () => { await ensureDefaultAdmin(); setUsersList(getUsers() || []); const logged = localStorage.getItem('ims_loggedInUser'); if (logged) { const u = (getUsers()||[]).find(x => x.username === logged); if (u) setCurrentUser(u); else localStorage.removeItem('ims_loggedInUser'); } })();
            }, []);

            const handleLogin = (username) => {
                const u = (getUsers()||[]).find(x => x.username === username);
                if (u) setCurrentUser(u);
                setUsersList(getUsers() || []);
            };

            const handleLogout = () => {
                localStorage.removeItem('ims_loggedInUser');
                setCurrentUser(null);
            };

            const handleUserListChange = (newList) => {
                setUsersList(newList);
            };

            if (!currentUser) {
                return <LoginScreen onLogin={handleLogin} />;
            }

            return (
                <div>
                    {/* Render the original app */}
                    <InventoryApp />
                    {/* Floating user controls */}
                    <UserWidget currentUser={currentUser} onLogout={handleLogout} onUserListChange={handleUserListChange} />
                </div>
            );
        };

        // Render AuthApp (instead of InventoryApp directly)
        ReactDOM.render(<AuthApp />, document.getElementById('root'));
    </script>
</body>
</html>
